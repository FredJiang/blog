---
title: UNIX 网络编程 笔记 8 -- 套接字选项
date: 2016-12-27 07:14:51
tags: [socket, unix, network, UNIX 网络编程]
---


### 7.5.5 SO_KEEPALIVE 套接字选项

给一个 TCP 套接字设置保持存活（keep-alive）选项后，如果 2 个小时内在该套接字的任一方向上都没有数据交换，TCP 就自动给对端发送一个保持存活探测分节（keep-alive probe），这是一个对端必须响应的 TCP 分节，它会导致以下三种情况之一。

* 对端以期望的 ACK 响应。应用进程得不到通知（因为一切正常）。在又经过仍无动静的 2 个小时后，TCP 将发出另外一个探测分节。
* 对端以 RST 响应，它告知本端 TCP：对端已崩溃且已重启。该套接字的待处理错误被置为 ECONNRESET，套接字本身则被关闭。
* 对端对保持存活探测分节没有任何响应。源自 Berkeley 的 TCP 将另外发送 8 个探测分节，两两相隔 75 秒，视图得到一个响应。TCP 在发出第一个探测分节后 11 分 15 秒内若没有得到任何响应则放弃。

如果根本没有对 TCP 的探测分节的响应，该套接字的待处理错误就被置为 ETIMEOUT，套接字本身则被关闭。然而如果该套接字收到一个 ICMP 错误作为某个探测分节的响应，那就返回相应的错误套接字本身也被关闭。这种情形下一个常见的 ICMP 错误是 “host unreachable”（主机不可达），说明对端主机可能并没有崩溃，只是不可达，这种情况下待处理错误被置为 EHOSTUNREACH。发生这种情况的原因或者是发生网络故障，或者是对端主机已经崩溃，而最后一跳路由器也检测到它的崩溃。

<!--more-->

### 7.5.8 SO_RCVBUF 和 SO_SNDBUF 套接字选项

每个套接字都有一个发送缓冲区和一个接收缓冲区。

接收缓冲区被 TCP、UDP 和 SCTP 用来保存接收到的数据，直到由应用进程来读取。对于 TCP 来说，套接字接收缓冲区中可用空间的大小限定了 TCP 通告对端的窗口大小。TCP 套接字接收缓冲区不可能溢出，因为不允许对端发出超过本端通告窗口的大小。这就是 TCP 的流量控制，如果对端无视窗口大小而发出了超过该窗口大小的数据，本端 TCP 将丢弃它们。然而对于 UDP 来说，当接收到的数据报装不进套接字接收缓冲区时，该数据报就被丢弃。UDP 是没有流量控制的：较快的发送端可以很容易地淹没较慢的接收端，导致接收端的 UDP 丢失数据报。事实上较快的发送端甚至可以淹没本机的网络接口，导致数据报被本机丢弃。

这两个套接字选项允许我们改变这两个缓冲区的默认大小。

### 7.5.11 SO_REUSEADDR 和 SO_REUSEPORT 套接字选项

SO_REUSEADDR 套接字选项能起到以下 4 个不同的功用。

1）SO_REUSEADDR 允许启动一个监听服务器并捆绑其众所周知端口，即使以前建立的将该端口用作它们的本地端口的连接仍存在。这个条件通常是正阳碰到的：

1. 启动一个监听服务器；
2. 连接请求到达，派生一个子进程来处理这个客户； 
3. 监听服务器终止，但子进程继续为现有连接上的客户提供服务；
4. 重启监听服务器。

默认情况下，当监听服务器在步骤 4 通过调用 socket、bind 和 listen 重启时，由于它试图捆绑一个现有连接（即正由早先派生的那个子进程处理着的连接）上的端口，从而 bind 调用会失败。但是如果该服务器在 socket 和 bind 两个调用之间设置了 SO_REUSEADDR 套接字选项，那么 bind 将成功。所有 TCP 服务器都应该指定本套接字选项，以允许服务器在这种情形下被重新启动。


2）SO_REUSEADDR 允许在同一端口上启动同一服务器的多个实例，只要每个实例捆绑一个不同的本地 IP 地址即可。

3）SO_REUSEADDR 允许单个进程捆绑同一端口到多个套接字上，只要每次捆绑指定不同的本地 IP 地址即可。

4）SO_REUSEADDR 允许完全重复的捆绑：当一个 IP 地址和端口已绑定到某个套接字上时，如果传输协议支持，同样的 IP 地址和端口还可以捆绑到另一个套接字上。一般来说，本特性仅支持 UDP 套接字。