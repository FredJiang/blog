---
title: UNIX 网络编程 笔记 10 -- ipv4 和 ipv6 通信
date: 2017-01-10 23:39:27
tags: [socket, unix, network, UNIX 网络编程]
---

### 12.2 IPv4 客户与 IPv6 服务器

双栈主机的一个基本特性是其上的 IPv6 服务器既能处理 IPv4 客户，又能处理 IPv6 客户。这是通过使用 IPv4 映射的 IPv6 地址实现的。

接收数据链路通过查看以太网类型字段把每个帧传递给相应的 IP 模块。IPv4 模块结合其上的 TCP 模块检测到 IPv4 数据报的目的端口对应一个 IPv6 套接字，于是把该数据报 IPv4 首部中的源 IPv4 地址转换成一个等价的 IPv4 映射的 IPv6 地址。当 accept 系统调用把这个已经接受的 IPv4 客户连接返回给服务器进程时，这个映射后的地址将作为客户的 IPv6 地址返回到服务器的 IPv6 套接字。该连接上其余的数据报同样都是 IPv4 数据报。


<!--more-->


当 accept 系统调用把接受的 IPv6 客户连接返回给服务器时，该客户的 IPv6 地址就是出现在 IPv6 首部中的源地址，未做任何改动。该连接上其余的数据报都是 IPv6 数据报。

我们可以把允许一个 IPv4 的 TCP 客户和一个 IPv6 的 TCP 服务器进行通信的步骤总结如下。

* IPv6 服务器启动后创建一个 IPv6 的监听套接字，我们假定服务器把通配地址捆绑到该套接字。
* IPv4 客户调用 gethostbyname 找到服务器主机的一个 A 记录。服务器主机既有一个 A 记录，又有一个 AAAA 记录，因为它同时支持 IPv4 和 IPv6，不过 IPv4 客户需要的只是一个 A 记录。
* 客户调用 connect，导致客户主机发送一个 IPv4 SYN 到服务器主机。
* 服务器主机接收这个目的地址为 IPv6 监听套接字的 IPv4 SYN，设置一个标志指示本连接应该使用 IPv4 映射的 IPv6 地址，然后响应以一个 IPv4 SYN/ACK。该连接建立后，由 accept 返回给服务器的地址就是这个 IPv4 映射的 IPv6 地址。
* 当服务器主机往这个 IPv4 映射的 IPv6 地址发送 TCP 分节时，其 IP 栈产生目的地址为所映射 IPv4 地址的 IPv4 载送数据报。因此，客户和服务器之间的所有通信都使用 IPv4 的载送数据报。
* 除非服务器显式检查这个 IPv6 地址是不是一个 IPv4 映射的 IPv6 地址，否则它永远不知道自己是在与一个 IPv4 客户通信。这个细节由双协议栈处理。同样地，IPv4 客户也不知道自己是在与一个 IPv6 服务器通信。


双栈主机上收到的 IPv4 数据报或 IPv6 数据报如何根据接收套接字的类型进行处理的流程。

* 如果收到一个目的地为某个 IPv4 套接字的 IPv4 数据报，那么无需任何特殊处理。客户和服务器之间交换的是 IPv4 数据报。
* 如果收到一个目的地为某个 IPv6 套接字的 IPv6 数据报，那么无需任何特殊处理。客户和服务器之间交换的是 IPv6 数据报。
* 如果收到一个目的地为某个 IPv6 套接字的 IPv4 数据报，那么内核把与该数据报的源 IPv4 地址对应的 IPv4 映射的 IPv6 地址作为 accept（TCP） 或 recvfrom（UDP）返回的对端 IPv6 地址。这样的映射是可行的，因为任何一个 IPv4 地址总能表示成一个 IPv6 地址。客户和服务器之间交换的是 IPv4 数据报。
* 上一点的相反面却不成立：一般说来，一个 IPv6 地址无法表示成一个 IPv4 地址。


大多数双栈主机在处理监听套接字时应使用以下规则。

* IPv4 监听套接字只能接受来自 IPv4 客户的外来连接。
* 如果服务器有一个绑定了通配地址的 IPv6 监听套接字，而且该套接字未设置 IPV6_V6ONLY 套接字选项，那么该套接字既能接受来自 IPv4 客户的外来连接，又能接受来自 IPv6 客户的外来连接。对于来自 IPv4 客户的连接而言，其服务器端的本地地址将是与某个本地 IPv4 地址对应的 IPv4 映射的 IPv6 地址。
